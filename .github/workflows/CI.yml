name: CI

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
concurrency:
    # Skip intermediate builds: always.
    # Cancel intermediate builds: only if it is a pull request build.
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: ${{ startsWith(github.ref, 'refs/pull/') }}

jobs:
    test:
        name: python ${{ matrix.version }} - ${{ matrix.os }} - ${{ matrix.arch }} - ${{ github.event_name }}
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                version:
                    - "lts"
                    - "1"
                os:
                    - ubuntu-latest
                    #- macOS-latest
                    #- windows-latest
                arch:
                    - x64
            strategy:
                matrix:
                    python-version: ["3.9", "3.10", "3.11"]
            steps:
                - name: Checkout
                  uses: actions/checkout@v4

                - name: Setup Rye
                  uses: eifinger/setup-rye@v3
                  with:
                      enable-cache: true

                - name: Pin Python Version
                  run: rye pin ${{ matrix.python-version }}

                - name: Install Dependencies
                  run: rye sync

                - name: Run Unit Tests (pytest)
                  run: rye run pytest tests/ --cov=src/ --cov-report=xml

                - name: Upload Coverage Report
                  uses: codecov/codecov-action@v3
                  with:
                      file: ./coverage.xml
                      fail_ci_if_error: true

    build:
        needs: test
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Rye
              uses: eifinger/setup-rye@v3
              with:
                  enable-cache: true

            - name: Build
              run: rye build
